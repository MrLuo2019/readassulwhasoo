/**
 * Created by shin on 2017/6/1.
 */
(function(a){a.cce={wechatDefaultOptions:{debug:false,appid:"",oauth:{auto:false,wechatOauthUrl:"https://open.weixin.qq.com/connect/oauth2/authorize",cceOauthUrl:"",redirect_uri:"",redirect_uri_query:{},validateQueryKey:"k",state:"",response_type:"code",scope:"snsapi_base",sharp:"wechat_redirect",beforeRedirect:null,callback:null,storge:{validateKey:"wechat_oauth_validate",userDataKey:"wechat_oauth_user",setData:function(b,c){return a.cookie(b,c)},getData:function(b){return a.cookie(b)},delData:function(b){a.cookie(b,null)}}},jssdk:{auto:false,signature:{async:false,url:"",retryTime:3,autoConfig:true,beforeSend:null,success:null,error:null},jsApiList:["checkJsApi","onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ","onMenuShareWeibo","onMenuShareQZone","hideMenuItems","showMenuItems","hideAllNonBaseMenuItem","showAllNonBaseMenuItem","translateVoice","startRecord","stopRecord","onVoiceRecordEnd","playVoice","onVoicePlayEnd","pauseVoice","stopVoice","uploadVoice","downloadVoice","chooseImage","previewImage","uploadImage","downloadImage","getNetworkType","openLocation","getLocation","hideOptionMenu","showOptionMenu","closeWindow","scanQRCode","chooseWXPay","openProductSpecificView","addCard","chooseCard","openCard"]}},storgeDefaultOptions:{key:"storge",setData:function(b,c){return a.cookie(b,c)},getData:function(b){return a.cookie(b)},delData:function(b){a.cookie(b,null)}},getOptions:function(b){return a.extend(true,a.cce.wechatDefaultOptions,b||{})},wechat:function(d){var b=new a.cce.jssdk(d);this.jssdkConfig=b.config;if(d.jssdk.auto==true){b.config()}var c=new a.cce.oauth(d);this.oauth=c.oauth;if(d.oauth.auto==true){c.oauth()}},oauth:function(b){var k=a.cce.getOptions(b);var h=new a.cce.storge({setData:k.oauth.storge.setData,getData:k.oauth.storge.getData,delData:k.oauth.storge.delData});var f=new a.cce.uri(window.location.href);var j=function(){var l=f.getQueryString(k.oauth.validateQueryKey);return l==h.getString(k.oauth.storge.validateKey)};var c=function(){var l={};var m=f.getQueryString("user");if(m&&m.length>0){try{l=JSON.parse(decodeURIComponent(m))}catch(n){}}return l};var d=function(){var l=null;var m=h.getJSON(k.oauth.storge.userDataKey);if(m&&m.openid&&m.openid.length>0){l=m}return l};var i=function(o){var n=new a.cce.uri(k.oauth.redirect_uri);n.extendQuery(k.oauth.redirect_uri_query);var q={};q[k.oauth.validateQueryKey]=o.toString();n.extendQuery(q);var r=n.format();a.cce.debug("Oauth","Get Callback Url",r,k.debug);var l=new a.cce.uri(k.oauth.wechatOauthUrl);var m={appid:k.appid,redirect_uri:encodeURIComponent(k.oauth.cceOauthUrl+"?link="+encodeURIComponent(r)),response_type:k.oauth.response_type,scope:k.oauth.scope,state:k.oauth.state};l.extendQuery(m);l.setExt(k.oauth.sharp);var p=l.format();a.cce.debug("Oauth","Get Oauth Url",p,k.debug);return p};var g=function(){var l={openid:f.getQueryString("openid"),user:c(),state:f.getQueryString("state"),query:f.uri.query};if(j()==true&&l.openid&&l.openid.length>0){return l}else{return null}};var e=function(){var o=d();a.cce.debug("Oauth","Is Oauth",o,k.debug);if(o!=null){return o}var l=g();a.cce.debug("Oauth","Is Callback",l,k.debug);if(l!=null){h.setJSON(k.oauth.storge.userDataKey,l);h.del(k.oauth.storge.validateKey);if(typeof k.oauth.callback=="function"){k.oauth.callback(l)}return l}var n=Math.round(new Date().getTime()/1000);var m=i(n);if(typeof k.oauth.beforeRedirect=="function"){if(k.oauth.beforeRedirect(m)===false){return}}h.setString(k.oauth.storge.validateKey,n.toString());window.location.href=m;return};this.getOauthUrl=i;this.oauth=e},jssdk:function(d){var c=a.cce.getOptions(d);a.cce.debug("Get Signature","Begin Request",c.jssdk.signature.url,c.debug);var f=0;var b=function(){if(f<c.jssdk.signature.retryTime){a.cce.debug("Get Signature","Retry Request "+(f+1),c.jssdk.signature.url,c.debug);f++;e()}};var e=function(){a.ajax({url:c.jssdk.signature.url,async:c.jssdk.signature.async,type:"get",dataType:"json",data:{url:encodeURIComponent(window.location.href)},beforeSend:c.jssdk.signature.beforeSend,success:function(g){if(g.Code=="10000"){a.cce.debug("Get Signature","Request Success",g,c.debug);if(typeof c.jssdk.signature.success=="function"){c.jssdk.signature.success(g.Data)}if(c.jssdk.signature.autoConfig==true){a.cce.debug("Get Signature","Begin Config",g.Data,c.debug);if(wx&&wx.config){wx.config({debug:c.debug,appId:c.appid,timestamp:g.Data.timestamp,nonceStr:g.Data.nonceStr,signature:g.Data.signature,jsApiList:c.jssdk.jsApiList})}}}else{a.cce.debug("Get Signature","Request Result Error",g,g,c.debug);b();if(typeof c.jssdk.signature.error=="function"){c.jssdk.signature.error(g)}}},error:function(g){a.cce.debug("Get Signature","Request Error",g,c.debug);b();if(typeof c.jssdk.signature.error=="function"){c.jssdk.signature.error(g)}}})};this.config=e},storge:function(d){var b=a.extend(true,a.cce.storgeDefaultOptions,d||{});var f=b.setData||function(g,h){};var e=b.getData||function(g){};var c=b.delData||function(g){};this.getString=function(g){return e(g)||""};this.setString=function(g,h){f(g,h)};this.getJSON=function(h){var g=null;var j=e(h);if(j&&j.length>0){try{g=JSON.parse(j)}catch(i){}}return g};this.setJSON=function(h,i){i=i||{};try{var g=JSON.stringify(i);f(h,g)}catch(j){}};this.del=function(g){c(g)};return this},log:function(b){if(typeof console=="object"){console.log(b)}else{alert(b)}},debug:function(c,d,e,b){if(b==true){c=c||"cce info";d=d||"debug";a.cce.log("["+c+"] "+d);a.cce.log(e)}},getQueryString:function(b){var c=new RegExp("(^|&)"+b+"=([^&]*)(&|$)","i");var d=window.location.search.substr(1).match(c);if(d!=null){return unescape(d[2])}return null},uri:function(f){var d={};var b=function(h){var i=/([^=&\s]+)[=\s]*([^=&\s]*)/g;var j={};while(i.exec(h)){j[RegExp.$1]=RegExp.$2}return j};var c=function(j){var i="";j=j||{};for(var h in j){i+=(h+"="+j[h]+"&")}if(i.length>0){i=i.substr(0,i.length-1)}return i};var g=function(j){var l={path:"",query:{},search:"",searchSplit:"?",ext:"",extSplit:"#"};if(j&&j.length>0){var k=j;var m=j.indexOf(l.extSplit);if(m>=0){k=j.substring(0,m);l.ext=j.substring(m+1,j.length)}var h=k;var i=k.indexOf(l.searchSplit);if(i>=0){h=k.substring(0,i);l.search=k.substring(i+1,k.length)}l.path=h;l.query=b(l.search)}return l};var e=function(){var i=d.search;if(!i||i.length==0){i=c(d.query)}var h=d.path;if(i&&i.length>0){h+=(d.searchSplit+i)}if(d.ext&&d.ext.length>0){h+=(d.extSplit+d.ext)}return h};d=g(f);this.uri=d;this.getQueryString=function(h){return d.query[h]||""};this.parse=g;this.format=e;this.extendQuery=function(h){d.query=a.extend(true,d.query,h||{});d.search=c(d.query)};this.setExt=function(h){d.ext=h}},isWXClient:function(){var b=window.navigator.userAgent.toLowerCase();return b.match(/MicroMessenger/i)=="micromessenger"},isWXJsUsed:function(){return((typeof wx)=="object"&&(typeof wx.config)=="function")}}})(jQuery);